
 JBoss, Home of Professional Open Source
 Copyright 2009, Red Hat, Inc., and others contributors as indicated
 by the @authors tag. All rights reserved.
 See the copyright.txt in the distribution for a
 full listing of individual contributors.
 This copyrighted material is made available to anyone wishing to use,
 modify, copy, or redistribute it subject to the terms and conditions
 of the GNU Lesser General Public License, v. 2.1.
 This program is distributed in the hope that it will be useful, but WITHOUT A
 WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
 PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.
 You should have received a copy of the GNU Lesser General Public License,
 v.2.1 along with this distribution; if not, write to the Free Software
 Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 MA  02110-1301, USA.

1. INTRODUCTION
===============
This example shows how to use an XA compliant database with BlackTie and has been tested against
ORACLE 11g. To compile in support for ORACLE you will need to pass a preprocessor macro called ORACLE
to the BlackTie utility that generates executables (as explained below).

To include a particular database during runtime you will need to update the BlackTie Environment.xml file
with information specific to the required database. The example xml files (in the linux and win32 directories)
includes notes and examples on how to configure ORACLE support.

Oracle 11g can be downloaded from:
http://www.oracle.com/technology/software/products/database/index.html (tested on release 11.1.0.6.0)

2. BUILDING THE EXAMPLE
=======================

Make sure your environment is suitable for running BlackTie applications by sourcing the setenv scripts
that came with the BlackTie distribution. On linux systems source:
    $BLACKTIE_BIN_DIR/setenv.sh
and on windows execute:
    %BLACKTIE_BIN_DIR%\setenv.bat

On Windows: 
You MUST use an environment configured with the VC++ development tools, e.g. launch:
C:\Program Files\Microsoft Visual Studio 9.0\VC\vcvarsall.bat

To compile a BlackTie client and server use the generate_client and generate_server scripts that came with the
distribution. The linux versions have a .sh suffix and windows versions have a .bat suffix.

generate_client accepts arguments that specify which files to compile (-Dclient.includes=...), location of any required
include directories (-Dx.inc.dir=) and the location of any required libraries (-Dx.lib.dir= and -Dx.libs=).
[If you need to pass in more include directories and libraries use -Dx.inc.dir2=..., -Dx.lib.dir2=... and -Dx.libs2=...].
It also accepts a list of preprocessor macro definitions (-Dx.define="comma separated list of macro names"). Thus, for example,
to compile the client for use with Oracle11g:

$BLACKTIE_BIN_DIR/bin/generate_client.sh -Dclient.includes="client.c request.c ora.c cutil.c" \
    -Dx.inc.dir="${ORACLE_HOME}/rdbms/public" \
    -Dx.lib.dir="${ORACLE_HOME}/lib" -Dx.libs="occi clntsh" \
    -Dx.define="ORACLE"

Similarly for generating the server:

$BLACKTIE_BIN_DIR/bin/generate_server.sh -Dservice.names=BAR -Dserver.includes="request.c ora.c DbService.c" \
    -Dx.inc.dir="${ORACLE_HOME}/rdbms/public" \
    -Dx.lib.dir="${ORACLE_HOME}/lib" -Dx.libs="occi clntsh" \
    -Dx.define="ORACLE"

Windows compile lines are similar.

NOTE: If you get the following error you have not edited or executed setenv correctly:
java org.apache.tools.ant.launch.Launcher -f /bin/generate-executables.xml -Dconfiguration.type=debug -Dbasedir=. -Dtoolchain.compiler=msvc server -Dservice.names=BAR -Dserver.includes="request.c ora.c DbService.c" -Dx.inc.dir="C:/<ora include dir>" -Dx.lib.dir="<ora lib dir>" -Dx.libs="occi.dll clntsh.dll" -Dx.define="ORACLE"
Exception in thread "main" java.lang.NoClassDefFoundError: org/apache/tools/ant/launch/Launcher
Caused by: java.lang.ClassNotFoundException: org.apache.tools.ant.launch.Launcher
        at java.net.URLClassLoader$1.run(URLClassLoader.java:200)
        at java.security.AccessController.doPrivileged(Native Method)
        at java.net.URLClassLoader.findClass(URLClassLoader.java:188)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:307)
        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:301)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:252)
        at java.lang.ClassLoader.loadClassInternal(ClassLoader.java:320)
Could not find the main class: org.apache.tools.ant.launch.Launcher.  Program will exit.

NOTE: On Windows - If you get the following error you have not used a command prompt with VC++ tools in it:
BUILD FAILED
C:\blacktie\dist\blacktie-1.0-MR6-SNAPSHOT\bin\generate-executables.xml:117: The following error occurred while executing this line:
C:\blacktie\dist\blacktie-1.0-MR6-SNAPSHOT\bin\generate-executables.xml:144: Could not launch cl: java.io.IOException: Cannot run program "cl" (in directory "C:
\blacktie\dist\blacktie-1.0-MR6-SNAPSHOT\examples\xatmi\txfooapp\target\classes"): CreateProcess error=2, The system cannot find the file specified


3. RUNNING THE EXAMPLE
======================
Start the JBoss server (<JBOSS_HOME>/bin/run.sh|bat -c all)
Make sure all required libraries are on the library path, something like
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${ORACLE_HOME}/lib
or
    set PATH=%PATH%;C:\<ora lib dir>

3.1 START THE SERVER
====================
    ./server -c <win32|linux> -i <unique_id - e.g. 1>

3.2 START THE CLIENT
====================
	indicate which platform the client is running on:
	export BLACKTIE_CONFIGURATION=<win32|linux>
    ./client

This runs a set of tests that exercise the various ways of interacting with resource managers. Please refer
to the source file cutil.c to see what client/server/transaction combinations are used.

APPENDIX: RECOVERY
==================
To test recovery you will need to link against a library that is only available in the test suite (which you'll need to build
from source - the library is called libdummy-rm.so).

When building the client and server define the macro TX_RC as shown below. When the client runs it sends a request to
the server that causes the server to generate a segmentation fault after the prepare phase of the transaction commitment
protocol. This will ensure that there is a pending transaction in need of recovery.

Restart the server. The BlackTie log (blacktie.log) should show the system recovering the failed transaction. The expected
message sequence is:

An entry that indicates BlackTie is attempting the recovery with the following message (for each failed branch):
	"... Recovering resource with branch id: <branch id> and recovery IOR: ..."
Then after one or two minutes the branch should attempt to commit with the following message:
	"... Commiting resource with branch id: <branch id>"

Note also that the Transaction Manager running in the JBoss AS should report messages on the console. One to show the
error that occurs when the server generates a segmentation fault during commit:
	"14:42:23,556 WARN  [loggerI18N] [com.arjuna.ats.internal.jts.resources.rrcaught] ResourceRecord commit - caught exception: org.omg.CORBA.TRANSIENT: Retries exceeded, couldn't reconnect to 127.0.0.1:9032  vmcid: 0x0  minor code: 0  completed: No"

and another message that indicates successful recovery of the pending transaction:
	"14:43:47,576 INFO  [loggerI18N] [com.arjuna.ats.internal.jts.recovery.transactions.TransactionCache_5] [com.arjuna.ats.internal.jts.recovery.transactions.TransactionCache_5] - Transaction 7f000001:e2a7:4aadfb4c:a89 recovery completed"

Required Configuration Changes:
-------------------------------

The XA resource that generates the segmentation fault needs to be included in Environment.xml as follows:
            <XA_RESOURCE>
                <XA_RESOURCE_MGR_ID>202</XA_RESOURCE_MGR_ID>
                <XA_RESOURCE_NAME>DummyDb</XA_RESOURCE_NAME>
                <XA_OPEN_STRING></XA_OPEN_STRING>
                <XA_CLOSE_STRING></XA_CLOSE_STRING>
                <XA_SWITCH>testxasw</XA_SWITCH>
                <XA_LIB_NAME>libdummy-rm.so</XA_LIB_NAME>
            </XA_RESOURCE>

After failure the server needs to either restart on the same ORB endpoint or needs to use a CORBA implementaton repository:
- to use the same end point add something similar to the following in the ORBOPT environment entry (the portspan is required
since the server can start more than one orb so a range of ports is necessary):
	<NAME>ORBOPT</NAME>
    <VALUE>-ORBListenEndpoints iiop://localhost:9032/portspan=10 -ORBInitRef ...</VALUE>
- or to use an implementation repository:
	<NAME>ORBOPT</NAME>
	<VALUE>-ORBUseImR 1 -ORBInitRef ...</VALUE>

Example command line for compiling and linking the server and client (defines the TX_RC macro and links against the
dummy XA resource library):

$BLACKTIE_BIN_DIR/bin/generate_client.sh -Dclient.includes="client.c request.c ora.c cutil.c" \
     -Dx.inc.dir="$HOME/blacktie/trunk/atmibroker-tx/target/cxx/test/include" \
     -Dx.inc.dir2="${ORACLE_HOME}/rdbms/public" \
     -Dx.lib.dir="$HOME/blacktie/trunk/atmibroker-tx/target/cxx/test/lib" -Dx.libs="dummy-rm" \
     -Dx.lib.dir2="${ORACLE_HOME}/lib" -Dx.libs2="occi clntsh" \
     -Dx.define="ORACLE, TX_RC"

$BLACKTIE_BIN_DIR/bin/generate_server.sh -Dservice.names=BAR -Dserver.includes="request.c ora.c DbService.c" \
     -Dx.inc.dir="$HOME/blacktie/trunk/atmibroker-tx/target/cxx/test/include" \
     -Dx.inc.dir2="${ORACLE_HOME}/rdbms/public" \
     -Dx.lib.dir="$HOME/blacktie/trunk/atmibroker-tx/target/cxx/test/lib" -Dx.libs="dummy-rm" \
     -Dx.lib.dir2="${ORACLE_HOME}/lib" -Dx.libs2="occi clntsh" \
     -Dx.define="ORACLE, TX_RC"

Note that the library path needs to include the location of the dummy-rm library. For example:

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${ORACLE_HOME}/lib:$HOME/blacktie/trunk/atmibroker-tx/target/cxx/test/lib

Note that recovery implies that the various components in the system need to store state on disk. If things don't go according
to plan you will need to either manually recover the transaction or, since this is only a demo example, manually
clear the logs:

	BlackTie recovery log: rclog and linux/rclog	# safe to delete these logs
	JBossTS logs: $JBOSS_HOME/server/<server name>/data/tx-object-store/
		# probably not wise to delete these unless you know that there are no other transactions in the system

